---
modules:
  - .efm_client
  - .conversions
---
include:
  - login_qs.yml
  - common_qs.yml
---
objects:
  person_to_reg: ALIndividual
---
code: |
  if 'jurisdiction_id' in url_args:
    jurisdiction_id = url_args['jurisdiction_id']
  else:
    jurisdiction_id = 'illinois'
---
code: |
  proxy_conn = ProxyConnection(credentials_code_block='tyler_login', default_jurisdiction=jurisdiction_id)
---
variable name: account_action_list
data: !!omap
  - register: "Register"
  - reset_user_password: "Reset your password"
  - self_resend_activation: "Resend activation email"
---
variable name: account_registration_choices
data: !!omap
  - INDIVIDUAL: Self-represented user
  - "FIRM_ADMINISTRATOR": Administrator of a new firm
---
code: |
  account_action_recompute = {
    "register": ["register_introduction", "person_to_reg", "register", "register_status"],
    "reset_user_password": ["reset_user_password", "show_resp"],
    "self_resend_activation": ["self_resend_activation", "show_resp"]
  }
---
mandatory: True
id: main-unauth-page
event: main_unauth_page
question: |
  eFile${ state_name_to_code(jurisdiction_id) } User Management
subquestion: |
  You aren't logged in, but you can take any of the below actions

  % for var, disp in account_action_list.items():
  ${ action_button_html(url_ask(
      [{'recompute': account_action_recompute[var]}]), 
      label=disp) }

  % endfor
---
id: unauth-email
question: |
  What is your account email?
fields:
  - Email: my_email
---
code: |
  resp = proxy_conn.reset_user_password(email=my_email)
  del my_email
  reset_user_password = True
---
code: |
  resp = proxy_conn.self_resend_activation_email(my_email)
  del my_email
  self_resend_activation = True
---
code: |
  resp = proxy_conn.register_user(person_to_reg, registration_type=reg_type, password=new_password, firm_name_or_id=showifdef('person_to_reg.firm_name', ''))
  del new_password
  register = True
---
id: unauth-action-completed
question: |
  Action completed
subquestion: |
  Response: ${ pretty_display(resp) }
continue button field: show_resp
---
id: unauth-register-done
question: |
  % if resp.is_ok():
  Successfully registered
  % else:
  Something went wrong when we tried to register your account
  % endif
subquestion: |
  % if resp.is_ok():
  You will get an email from efile${ state_name_to_code(jurisdiction_id) } asking you to activate your account.
  
  [Resend activation email](${ url_ask([{'recompute': ['self_resend_activation','show_resp']}]) })

  % else:
  ${ debug_display(resp) }
  % endif

continue button field: register_status
---
id: unauth-intro
question: |
  This website will help you register as an e-filing user in ${ jurisdiction_id.title() }
subquestion: |
  You will need to provide your email and create a password.
continue button field: register_introduction